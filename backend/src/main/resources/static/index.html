<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MailVault - Caixa Historica</title>
  <style>
    :root {
      --bg: #f7f4ef;
      --bg-2: #ede5d8;
      --panel: #fffdfa;
      --line: #d9cfbf;
      --ink: #1d1a15;
      --muted: #5e5649;
      --accent: #176d5b;
      --accent-strong: #0e4f41;
      --danger: #7a2f2f;
      --shadow: 0 16px 30px rgba(37, 31, 20, 0.08);
      --radius-lg: 18px;
      --radius-md: 12px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      color: var(--ink);
      font-family: "Iowan Old Style", "Palatino Linotype", "Book Antiqua", Palatino, serif;
      background:
        radial-gradient(circle at 10% 0%, rgba(23, 109, 91, 0.13), transparent 40%),
        radial-gradient(circle at 100% 15%, rgba(182, 132, 58, 0.12), transparent 42%),
        linear-gradient(140deg, var(--bg), var(--bg-2));
      min-height: 100vh;
    }

    .wrap {
      width: min(1080px, 92vw);
      margin: 28px auto 42px;
    }

    .hero {
      background: linear-gradient(145deg, #1e5b4e, #143d34);
      color: #f8f5ef;
      border-radius: var(--radius-lg);
      padding: 22px 24px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .hero::after {
      content: "";
      position: absolute;
      width: 260px;
      height: 260px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(244, 203, 142, 0.28), rgba(244, 203, 142, 0));
      right: -80px;
      top: -110px;
      pointer-events: none;
    }

    h1 {
      margin: 0 0 6px;
      letter-spacing: 0.4px;
      font-size: clamp(1.7rem, 2.6vw, 2.2rem);
    }

    .hero p {
      margin: 0;
      color: rgba(248, 245, 239, 0.9);
      font-size: 1.02rem;
    }

    .panel {
      margin-top: 18px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .stats-panel {
      margin-top: 12px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 14px 16px;
    }

    .stats-title {
      margin: 0 0 10px;
      font-size: 1.02rem;
      color: #2a241c;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .stats-card {
      border: 1px solid #d8cab5;
      border-radius: 10px;
      padding: 10px;
      background: #fffcf6;
    }

    .stats-label {
      font-size: .78rem;
      color: #6b5f4b;
      margin-bottom: 4px;
    }

    .stats-value {
      font-size: 1.02rem;
      font-weight: 700;
      color: #2b2419;
    }

    .search {
      display: grid;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, #fffcf6, #fbf6eb);
    }

    .search-top {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items: center;
    }

    .search input,
    .search select {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid #ccbda8;
      padding: 11px 12px;
      font: inherit;
      color: var(--ink);
      background: #fff;
    }

    .search input:focus,
    .search select:focus {
      outline: 2px solid rgba(23, 109, 91, 0.2);
      border-color: var(--accent);
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      align-items: end;
    }

    .filter-field {
      display: grid;
      gap: 4px;
    }

    .filter-field label {
      font-size: .82rem;
      color: var(--muted);
      font-weight: 700;
    }

    .filter-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      min-height: 28px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #efe4d0;
      border: 1px solid #d7c5a8;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: .82rem;
      color: #5f4f36;
    }

    .chip button {
      border: none;
      background: transparent;
      color: #5f4f36;
      padding: 0;
      line-height: 1;
      font-weight: 700;
      cursor: pointer;
    }

    button, .btn {
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      padding: 10px 14px;
      font: inherit;
      cursor: pointer;
      text-decoration: none;
      transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 8px 20px rgba(23, 109, 91, 0.22);
    }

    .btn-primary:hover { background: var(--accent-strong); transform: translateY(-1px); }

    .btn-ghost {
      background: #fff;
      color: var(--ink);
      border-color: #c8bca9;
    }

    .btn-ghost:hover { background: #f4eee2; }

    .meta {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      padding: 12px 16px;
      background: #faf6ee;
      border-bottom: 1px solid var(--line);
      color: var(--muted);
      font-size: .96rem;
    }

    .ops {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      background: #fff9ee;
    }

    .ops-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .ops-status {
      color: var(--muted);
      font-size: .92rem;
      min-height: 20px;
      border-radius: 8px;
      padding: 4px 8px;
      border: 1px solid transparent;
    }

    .ops-status.ok {
      color: #1f613f;
      background: #e9f6ef;
      border-color: #b7ddc6;
    }

    .ops-status.error {
      color: #772828;
      background: #fdeeee;
      border-color: #edc6c6;
    }

    .ops-status.info {
      color: #1e4c75;
      background: #ebf3fb;
      border-color: #b8d2ea;
    }

    .kbd {
      font-family: "Consolas", "Liberation Mono", monospace;
      background: #f1e8d8;
      border: 1px solid #d5c7ad;
      border-radius: 8px;
      padding: 1px 6px;
      color: #6d5a39;
      font-size: .78rem;
    }

    .list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .item {
      border-bottom: 1px solid var(--line);
      padding: 14px 16px;
      transition: background-color .12s ease;
    }

    .item:last-child { border-bottom: none; }
    .item:hover { background: #fff6e8; }

    .item a {
      color: #133f74;
      font-weight: 600;
      text-decoration: none;
    }

    .item a:hover { text-decoration: underline; }

    .item-meta {
      color: var(--muted);
      margin-bottom: 5px;
      font-size: .93rem;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .dot::before {
      content: "•";
      margin-right: 8px;
      color: #978162;
    }

    .item-subject {
      display: inline-block;
      margin-bottom: 4px;
    }

    .item-head {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }

    .item-badges {
      display: inline-flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .mini-badge {
      font-size: .74rem;
      line-height: 1;
      border-radius: 999px;
      border: 1px solid #d8cab5;
      padding: 4px 8px;
      background: #f7efe1;
      color: #5f4f36;
      white-space: nowrap;
    }

    .mini-badge.warn {
      border-color: #d9b48e;
      background: #fff0dd;
      color: #7a4d17;
    }

    .mini-badge.danger {
      border-color: #d39b9b;
      background: #fff0f0;
      color: #8a2f2f;
    }

    .item-snippet {
      color: #6a604f;
      font-size: .9rem;
      line-height: 1.3;
    }

    mark {
      background: #fff1be;
      color: #3d2d0c;
      padding: 0 2px;
      border-radius: 3px;
    }

    .empty, .error, .loading {
      padding: 22px 16px;
      color: var(--muted);
    }

    .error { color: var(--danger); }

    .pager {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 12px 16px 16px;
      background: #fffcf6;
      border-top: 1px solid var(--line);
    }

    .pager-actions {
      display: flex;
      gap: 8px;
    }

    @media (max-width: 760px) {
      .wrap { width: min(1080px, 95vw); }
      .search-top {
        grid-template-columns: 1fr;
      }
      .filters-grid {
        grid-template-columns: 1fr;
      }
      .meta,
      .ops,
      .pager {
        flex-direction: column;
        align-items: flex-start;
      }
      .stats-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="hero">
      <h1>MailVault</h1>
      <p>Caixa historica para consulta rapida de mensagens indexadas.</p>
    </section>

    <section class="stats-panel">
      <h2 class="stats-title">Status</h2>
      <div class="stats-grid">
        <div class="stats-card"><div class="stats-label">Mensagens</div><div id="statTotalMessages" class="stats-value">-</div></div>
        <div class="stats-card"><div class="stats-label">Com HTML</div><div id="statTotalWithHtml" class="stats-value">-</div></div>
        <div class="stats-card"><div class="stats-label">Anexos</div><div id="statTotalAttachments" class="stats-value">-</div></div>
        <div class="stats-card"><div class="stats-label">Assets baixados</div><div id="statAssetsDownloaded" class="stats-value">-</div></div>
        <div class="stats-card"><div class="stats-label">Assets falhos</div><div id="statAssetsFailed" class="stats-value">-</div></div>
        <div class="stats-card"><div class="stats-label">Bytes anexos</div><div id="statBytesAttachments" class="stats-value">-</div></div>
        <div class="stats-card"><div class="stats-label">Bytes assets</div><div id="statBytesAssets" class="stats-value">-</div></div>
        <div class="stats-card"><div class="stats-label">Ultimo index</div><div id="statLastIndexAt" class="stats-value">-</div></div>
      </div>
    </section>

    <section class="panel">
      <form id="searchForm" class="search">
        <div class="search-top">
          <input id="query" type="text" placeholder="Buscar por assunto, remetente ou termos do conteudo" autocomplete="off" />
          <button type="submit" class="btn-primary">Buscar</button>
          <button id="clearBtn" type="button" class="btn-ghost">Limpar tudo</button>
        </div>
        <div class="filters-grid">
          <div class="filter-field">
            <label for="yearFilter">Ano</label>
            <input id="yearFilter" type="number" min="1970" max="2100" placeholder="Todos" />
          </div>
          <div class="filter-field">
            <label for="hasAttachmentsFilter">Anexos</label>
            <select id="hasAttachmentsFilter">
              <option value="">Todos</option>
              <option value="true">Com anexos</option>
              <option value="false">Sem anexos</option>
            </select>
          </div>
          <div class="filter-field">
            <label for="hasHtmlFilter">HTML</label>
            <select id="hasHtmlFilter">
              <option value="">Todos</option>
              <option value="true">Com HTML</option>
              <option value="false">Sem HTML</option>
            </select>
          </div>
          <div class="filter-field">
            <label for="hasFrozenImagesFilter">Imagens congeladas</label>
            <select id="hasFrozenImagesFilter">
              <option value="">Todos</option>
              <option value="true">Com imagens congeladas</option>
              <option value="false">Sem imagens congeladas</option>
            </select>
          </div>
        </div>
        <div class="filter-actions">
          <div id="activeFilters" class="chips"></div>
        </div>
      </form>

      <div class="ops">
        <div class="ops-actions">
          <button id="indexBtn" type="button" class="btn-primary">Indexar (incremental)</button>
          <button id="reindexBtn" type="button" class="btn-ghost">Reindexar (completo)</button>
          <button id="freezePendingBtn" type="button" class="btn-ghost">Congelar pendentes</button>
          <button id="maintenanceBtn" type="button" class="btn-ghost">Manutencao (limpeza/vacuum)</button>
        </div>
        <span id="indexStatus" class="ops-status"></span>
      </div>

      <div class="meta">
        <span id="summary">Carregando mensagens...</span>
        <span>Dica: pressione <span class="kbd">/</span> para focar a busca</span>
      </div>

      <ul id="results" class="list"></ul>

      <div class="pager">
        <span id="pageInfo">Pagina 1</span>
        <div class="pager-actions">
          <button id="prevBtn" type="button" class="btn-ghost">Anterior</button>
          <button id="nextBtn" type="button" class="btn-ghost">Proxima</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const PAGE_SIZE = 40;

    const searchForm = document.getElementById('searchForm');
    const queryInput = document.getElementById('query');
    const yearFilter = document.getElementById('yearFilter');
    const hasAttachmentsFilter = document.getElementById('hasAttachmentsFilter');
    const hasHtmlFilter = document.getElementById('hasHtmlFilter');
    const hasFrozenImagesFilter = document.getElementById('hasFrozenImagesFilter');
    const activeFilters = document.getElementById('activeFilters');
    const clearBtn = document.getElementById('clearBtn');
    const results = document.getElementById('results');
    const summary = document.getElementById('summary');
    const indexBtn = document.getElementById('indexBtn');
    const reindexBtn = document.getElementById('reindexBtn');
    const freezePendingBtn = document.getElementById('freezePendingBtn');
    const maintenanceBtn = document.getElementById('maintenanceBtn');
    const indexStatus = document.getElementById('indexStatus');
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const statTotalMessages = document.getElementById('statTotalMessages');
    const statTotalWithHtml = document.getElementById('statTotalWithHtml');
    const statTotalAttachments = document.getElementById('statTotalAttachments');
    const statAssetsDownloaded = document.getElementById('statAssetsDownloaded');
    const statAssetsFailed = document.getElementById('statAssetsFailed');
    const statBytesAttachments = document.getElementById('statBytesAttachments');
    const statBytesAssets = document.getElementById('statBytesAssets');
    const statLastIndexAt = document.getElementById('statLastIndexAt');

    let state = {
      page: 0,
      total: 0,
      query: '',
      year: null,
      hasAttachments: null,
      hasHtml: null,
      hasFrozenImages: null,
      itemsCount: 0,
      items: [],
      loading: false,
    };

    function escapeHtml(value) {
      return (value ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;');
    }

    function escapeRegExp(value) {
      return value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function extractHighlightTerms(query) {
      if (!query) {
        return [];
      }
      const terms = query.match(/[A-Za-z0-9À-ÿ]{2,}/g) || [];
      return [...new Set(terms.map((term) => term.toLowerCase()))]
        .sort((a, b) => b.length - a.length)
        .slice(0, 8);
    }

    function highlightText(text, query) {
      const source = text || '';
      const terms = extractHighlightTerms(query);
      if (!terms.length || !source) {
        return escapeHtml(source);
      }
      const pattern = new RegExp(`(${terms.map(escapeRegExp).join('|')})`, 'gi');
      return source
        .split(pattern)
        .map((part, index) => (index % 2 === 1 ? `<mark>${escapeHtml(part)}</mark>` : escapeHtml(part)))
        .join('');
    }

    function formatDate(epochMs) {
      const numeric = Number(epochMs);
      if (!Number.isFinite(numeric) || numeric <= 0) {
        return '(sem data)';
      }
      return new Intl.DateTimeFormat('pt-BR', {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
      }).format(new Date(numeric));
    }

    function currentQueryFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return (params.get('query') || '').trim();
    }

    function currentYearFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const value = params.get('year');
      if (!value) {
        return null;
      }
      const parsed = Number(value);
      if (!Number.isFinite(parsed) || parsed < 0) {
        return null;
      }
      return Math.floor(parsed);
    }

    function parseBooleanParam(value) {
      if (value === 'true') {
        return true;
      }
      if (value === 'false') {
        return false;
      }
      return null;
    }

    function currentBooleanFilterFromUrl(key) {
      const params = new URLSearchParams(window.location.search);
      return parseBooleanParam(params.get(key));
    }

    function currentPageFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const page = Number(params.get('page') || '0');
      if (!Number.isFinite(page) || page < 0) {
        return 0;
      }
      return Math.floor(page);
    }

    function syncUrl() {
      const params = new URLSearchParams();
      if (state.query) {
        params.set('query', state.query);
      }
      if (state.year !== null) {
        params.set('year', String(state.year));
      }
      if (state.hasAttachments !== null) {
        params.set('hasAttachments', String(state.hasAttachments));
      }
      if (state.hasHtml !== null) {
        params.set('hasHtml', String(state.hasHtml));
      }
      if (state.hasFrozenImages !== null) {
        params.set('hasFrozenImages', String(state.hasFrozenImages));
      }
      if (state.page > 0) {
        params.set('page', String(state.page));
      }
      const queryString = params.toString();
      const newUrl = queryString ? `/?${queryString}` : '/';
      window.history.replaceState(null, '', newUrl);
      window.sessionStorage.setItem('mailvault:lastListQuery', queryString ? `?${queryString}` : '');
    }

    function renderMeta() {
      const start = state.total === 0 ? 0 : (state.page * PAGE_SIZE) + 1;
      const end = state.page * PAGE_SIZE + state.itemsCount;
      if (state.loading) {
        summary.textContent = 'Carregando mensagens...';
      } else if (state.total === 0) {
        summary.textContent = hasActiveFilters() ? 'Nenhum resultado para os filtros atuais.' : 'Nao ha mensagens indexadas ainda.';
      } else {
        summary.textContent = `Exibindo ${start}-${end} de ${state.total} mensagens`;
      }

      const totalPages = Math.max(1, Math.ceil(state.total / PAGE_SIZE));
      pageInfo.textContent = `Pagina ${Math.min(state.page + 1, totalPages)} de ${totalPages}`;
      prevBtn.disabled = state.loading || state.page <= 0;
      nextBtn.disabled = state.loading || (state.page + 1) * PAGE_SIZE >= state.total;
    }

    function renderItems(items, errorMessage) {
      if (errorMessage) {
        results.innerHTML = `<li class="error">${escapeHtml(errorMessage)}</li>`;
        return;
      }

      if (state.loading) {
        results.innerHTML = '<li class="loading">Atualizando resultados...</li>';
        return;
      }

      if (!items.length) {
        results.innerHTML = '<li class="empty">Nenhuma mensagem encontrada.</li>';
        return;
      }

      results.innerHTML = items.map((item) => {
        const date = formatDate(item.dateEpoch ?? item.fileMtimeEpoch);
        const from = item.fromDisplay || item.fromRaw || '(sem remetente)';
        const subject = item.subjectDisplay || item.subject || '(sem assunto)';
        const snippet = item.snippet || '(sem preview)';
        const highlightedSubject = highlightText(subject, state.query);
        const highlightedSnippet = highlightText(snippet, state.query);
        const badges = [];
        const attachmentsCount = Number(item.attachmentsCount || 0);
        const frozenAssetsCount = Number(item.frozenAssetsCount || 0);
        const assetsFailedCount = Number(item.assetsFailedCount || 0);
        if (item.hasHtml) {
          badges.push('<span class="mini-badge">HTML</span>');
        }
        if (attachmentsCount > 0) {
          badges.push(`<span class="mini-badge">Anexos: ${attachmentsCount}</span>`);
        }
        if (frozenAssetsCount > 0) {
          badges.push('<span class="mini-badge warn">Congelado</span>');
        }
        if (assetsFailedCount > 0) {
          badges.push(`<span class="mini-badge danger">Falha: ${assetsFailedCount}</span>`);
        }
        const detailParams = new URLSearchParams();
        if (window.location.search) {
          detailParams.set('return', window.location.search);
        }
        const detailSuffix = detailParams.toString();
        return `
          <li class="item">
            <div class="item-meta">
              <span>${escapeHtml(date)}</span>
              <span class="dot">${escapeHtml(from)}</span>
            </div>
            <div class="item-head">
              <a class="item-subject" href="/messages/${encodeURIComponent(item.id)}${detailSuffix ? `?${detailSuffix}` : ''}">${highlightedSubject}</a>
              <span class="item-badges">${badges.join('')}</span>
            </div>
            <div class="item-snippet">${highlightedSnippet}</div>
          </li>`;
      }).join('');
    }

    async function loadMessages() {
      state.loading = true;
      renderMeta();
      renderItems([], null);

      const params = new URLSearchParams({
        page: String(state.page),
        size: String(PAGE_SIZE),
      });
      if (state.query) {
        params.set('query', state.query);
      }
      if (state.year !== null) {
        params.set('year', String(state.year));
      }
      if (state.hasAttachments !== null) {
        params.set('hasAttachments', String(state.hasAttachments));
      }
      if (state.hasHtml !== null) {
        params.set('hasHtml', String(state.hasHtml));
      }
      if (state.hasFrozenImages !== null) {
        params.set('hasFrozenImages', String(state.hasFrozenImages));
      }

      try {
        const response = await fetch(`/api/messages?${params.toString()}`);
        if (!response.ok) {
          state.loading = false;
          state.items = [];
          state.total = 0;
          state.itemsCount = 0;
          renderMeta();
          renderItems([], 'Erro ao carregar mensagens.');
          return;
        }

        const data = await response.json();
        const items = data.items || [];
        state.items = items;
        state.total = Number(data.total || 0);
        state.itemsCount = items.length;
        state.loading = false;
        renderMeta();
        renderItems(items, null);
      } catch (_) {
        state.loading = false;
        state.items = [];
        state.total = 0;
        state.itemsCount = 0;
        renderMeta();
        renderItems([], 'Falha de rede ao carregar mensagens.');
      }
    }

    function applyAndLoad(next) {
      state = { ...state, ...next };
      renderActiveFilters();
      syncUrl();
      loadMessages();
    }

    function hasActiveFilters() {
      return Boolean(
        state.query ||
        state.year !== null ||
        state.hasAttachments !== null ||
        state.hasHtml !== null ||
        state.hasFrozenImages !== null,
      );
    }

    function renderActiveFilters() {
      const chips = [];
      if (state.query) {
        chips.push({ key: 'query', label: `Busca: ${state.query}` });
      }
      if (state.year !== null) {
        chips.push({ key: 'year', label: `Ano: ${state.year}` });
      }
      if (state.hasAttachments !== null) {
        chips.push({ key: 'hasAttachments', label: `Anexos: ${state.hasAttachments ? 'sim' : 'nao'}` });
      }
      if (state.hasHtml !== null) {
        chips.push({ key: 'hasHtml', label: `HTML: ${state.hasHtml ? 'sim' : 'nao'}` });
      }
      if (state.hasFrozenImages !== null) {
        chips.push({ key: 'hasFrozenImages', label: `Imagens congeladas: ${state.hasFrozenImages ? 'sim' : 'nao'}` });
      }

      if (!chips.length) {
        activeFilters.innerHTML = '';
        return;
      }

      activeFilters.innerHTML = chips.map((chip) => `
        <span class="chip">
          ${escapeHtml(chip.label)}
          <button type="button" data-filter-key="${chip.key}" aria-label="Remover filtro">x</button>
        </span>
      `).join('');
    }

    function clearFilterByKey(key) {
      const patch = { page: 0 };
      if (key === 'query') {
        patch.query = '';
      }
      if (key === 'year') {
        patch.year = null;
      }
      if (key === 'hasAttachments') {
        patch.hasAttachments = null;
      }
      if (key === 'hasHtml') {
        patch.hasHtml = null;
      }
      if (key === 'hasFrozenImages') {
        patch.hasFrozenImages = null;
      }
      syncFormFromState({ ...state, ...patch });
      applyAndLoad(patch);
    }

    function syncFormFromState(nextState = state) {
      queryInput.value = nextState.query || '';
      yearFilter.value = nextState.year === null ? '' : String(nextState.year);
      hasAttachmentsFilter.value = nextState.hasAttachments === null ? '' : String(nextState.hasAttachments);
      hasHtmlFilter.value = nextState.hasHtml === null ? '' : String(nextState.hasHtml);
      hasFrozenImagesFilter.value = nextState.hasFrozenImages === null ? '' : String(nextState.hasFrozenImages);
    }

    function formatNumber(value) {
      return Number(value || 0).toLocaleString('pt-BR');
    }

    function setStatsFallback() {
      statTotalMessages.textContent = '-';
      statTotalWithHtml.textContent = '-';
      statTotalAttachments.textContent = '-';
      statAssetsDownloaded.textContent = '-';
      statAssetsFailed.textContent = '-';
      statBytesAttachments.textContent = '-';
      statBytesAssets.textContent = '-';
      statLastIndexAt.textContent = '-';
    }

    async function loadStats() {
      try {
        const response = await fetch('/api/stats');
        if (!response.ok) {
          setStatsFallback();
          return;
        }
        const stats = await response.json();
        statTotalMessages.textContent = formatNumber(stats.totalMessages);
        statTotalWithHtml.textContent = formatNumber(stats.totalWithHtml);
        statTotalAttachments.textContent = formatNumber(stats.totalAttachments);
        statAssetsDownloaded.textContent = formatNumber(stats.totalAssetsDownloaded);
        statAssetsFailed.textContent = formatNumber(stats.totalAssetsFailed);
        statBytesAttachments.textContent = formatNumber(stats.storageBytesAttachments);
        statBytesAssets.textContent = formatNumber(stats.storageBytesAssets);
        statLastIndexAt.textContent = stats.lastIndexAt || '-';
      } catch (_) {
        setStatsFallback();
      }
    }

    function setIndexRunning(running) {
      indexBtn.disabled = running;
      reindexBtn.disabled = running;
      freezePendingBtn.disabled = running;
      maintenanceBtn.disabled = running;
    }

    function setOpsStatus(kind, message) {
      indexStatus.className = `ops-status ${kind}`;
      indexStatus.textContent = message;
    }

    async function runIndex(actionLabel) {
      setIndexRunning(true);
      setOpsStatus('info', `${actionLabel} em andamento...`);
      try {
        const response = await fetch('/api/index', { method: 'POST' });
        if (!response.ok) {
          setOpsStatus('error', `Falha ao ${actionLabel.toLowerCase()}.`);
          return;
        }
        const data = await response.json();
        setOpsStatus('ok', `${actionLabel} concluida: inserted=${data.inserted}, updated=${data.updated}, skipped=${data.skipped}`);
        applyAndLoad({ page: 0 });
        loadStats();
      } catch (_) {
        setOpsStatus('error', `Falha de rede ao ${actionLabel.toLowerCase()}.`);
      } finally {
        setIndexRunning(false);
      }
    }

    async function runMaintenance() {
      setIndexRunning(true);
      setOpsStatus('info', 'Manutencao em andamento...');
      try {
        const cleanupRes = await fetch('/api/maintenance/cleanup', { method: 'POST' });
        if (!cleanupRes.ok) {
          setOpsStatus('error', 'Falha ao executar limpeza.');
          return;
        }
        const cleanup = await cleanupRes.json();

        const vacuumRes = await fetch('/api/maintenance/vacuum', { method: 'POST' });
        if (!vacuumRes.ok) {
          setOpsStatus('error', 'Limpeza concluida, mas VACUUM falhou.');
          return;
        }
        const vacuum = await vacuumRes.json();
        setOpsStatus(
          'ok',
          `Manutencao concluida: arquivosRemovidos=${cleanup.removedAttachmentFiles + cleanup.removedAssetFiles}, mensagensRemovidas=${cleanup.removedMissingMessageRows}, vacuumMs=${vacuum.durationMs}`,
        );
        applyAndLoad({ page: 0 });
        loadStats();
      } catch (_) {
        setOpsStatus('error', 'Falha de rede ao executar manutencao.');
      } finally {
        setIndexRunning(false);
      }
    }

    async function runFreezePending() {
      const candidates = (state.items || []).filter((item) =>
        item.hasHtml && Number(item.frozenAssetsCount || 0) <= 0);

      if (!candidates.length) {
        setOpsStatus('info', 'Nenhuma mensagem pendente de freeze nesta pagina.');
        return;
      }

      const confirmed = window.confirm(
        `Congelar imagens em ${candidates.length} mensagem(ns) pendente(s) da pagina atual?`,
      );
      if (!confirmed) {
        return;
      }

      setIndexRunning(true);
      let processed = 0;
      let downloaded = 0;
      let failed = 0;
      let skipped = 0;
      let requestErrors = 0;

      try {
        for (const item of candidates) {
          setOpsStatus('info', `Congelando pendentes... ${processed + 1}/${candidates.length}`);
          try {
            const response = await fetch(`/api/messages/${encodeURIComponent(item.id)}/freeze-assets`, { method: 'POST' });
            if (!response.ok) {
              requestErrors += 1;
            } else {
              const data = await response.json();
              downloaded += Number(data.downloaded || 0);
              failed += Number(data.failed || 0);
              skipped += Number(data.skipped || 0);
            }
          } catch (_) {
            requestErrors += 1;
          }
          processed += 1;
        }

        setOpsStatus(
          requestErrors > 0 ? 'error' : 'ok',
          `Freeze pendentes concluido: mensagens=${processed}, baixadas=${downloaded}, falhas=${failed}, ignoradas=${skipped}, errosReq=${requestErrors}`,
        );
        await loadMessages();
        await loadStats();
      } finally {
        setIndexRunning(false);
      }
    }

    searchForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const parsedYearRaw = yearFilter.value.trim();
      const parsedYear = parsedYearRaw ? Number(parsedYearRaw) : null;
      applyAndLoad({
        query: queryInput.value.trim(),
        year: Number.isFinite(parsedYear) && parsedYear >= 0 ? Math.floor(parsedYear) : null,
        hasAttachments: parseBooleanParam(hasAttachmentsFilter.value),
        hasHtml: parseBooleanParam(hasHtmlFilter.value),
        hasFrozenImages: parseBooleanParam(hasFrozenImagesFilter.value),
        page: 0,
      });
    });

    clearBtn.addEventListener('click', () => {
      syncFormFromState({
        ...state,
        query: '',
        year: null,
        hasAttachments: null,
        hasHtml: null,
        hasFrozenImages: null,
      });
      applyAndLoad({
        query: '',
        year: null,
        hasAttachments: null,
        hasHtml: null,
        hasFrozenImages: null,
        page: 0,
      });
      queryInput.focus();
    });

    activeFilters.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) {
        return;
      }
      const key = target.getAttribute('data-filter-key');
      if (!key) {
        return;
      }
      clearFilterByKey(key);
    });

    indexBtn.addEventListener('click', () => {
      runIndex('Indexacao incremental');
    });

    reindexBtn.addEventListener('click', () => {
      const confirmed = window.confirm(
        'Reindexacao completa vai reler todos os .eml e atualizar metadados/corpos. Pode demorar. Deseja continuar?',
      );
      if (!confirmed) {
        return;
      }
      runIndex('Reindexacao completa');
    });

    maintenanceBtn.addEventListener('click', () => {
      const confirmed = window.confirm(
        'Manutencao remove arquivos orfaos e executa VACUUM no SQLite. Pode consumir IO e tempo. Deseja continuar?',
      );
      if (!confirmed) {
        return;
      }
      runMaintenance();
    });

    freezePendingBtn.addEventListener('click', () => {
      runFreezePending();
    });

    prevBtn.addEventListener('click', () => {
      if (state.page > 0) {
        applyAndLoad({ page: state.page - 1 });
      }
    });

    nextBtn.addEventListener('click', () => {
      if ((state.page + 1) * PAGE_SIZE < state.total) {
        applyAndLoad({ page: state.page + 1 });
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === '/' && document.activeElement !== queryInput) {
        event.preventDefault();
        queryInput.focus();
      }
    });

    window.addEventListener('popstate', () => {
      state.query = currentQueryFromUrl();
      state.year = currentYearFromUrl();
      state.hasAttachments = currentBooleanFilterFromUrl('hasAttachments');
      state.hasHtml = currentBooleanFilterFromUrl('hasHtml');
      state.hasFrozenImages = currentBooleanFilterFromUrl('hasFrozenImages');
      state.page = currentPageFromUrl();
      syncFormFromState();
      renderActiveFilters();
      loadMessages();
    });

    state.query = currentQueryFromUrl();
    state.year = currentYearFromUrl();
    state.hasAttachments = currentBooleanFilterFromUrl('hasAttachments');
    state.hasHtml = currentBooleanFilterFromUrl('hasHtml');
    state.hasFrozenImages = currentBooleanFilterFromUrl('hasFrozenImages');
    state.page = currentPageFromUrl();
    syncFormFromState();
    renderActiveFilters();
    loadMessages();
    loadStats();
  </script>
</body>
</html>
